<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: actionscript3.0 | 林克融]]></title>
  <link href="http://sayaku.github.io/blog/categories/actionscript3-dot-0/atom.xml" rel="self"/>
  <link href="http://sayaku.github.io/"/>
  <updated>2016-10-20T09:57:39+08:00</updated>
  <id>http://sayaku.github.io/</id>
  <author>
    <name><![CDATA[sayaku]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[AirKinect 簡易手指偵測]]></title>
    <link href="http://sayaku.github.io/blog/2013/01/29/airkinectdetec/"/>
    <updated>2013-01-29T20:26:19+08:00</updated>
    <id>http://sayaku.github.io/blog/2013/01/29/airkinectdetec</id>
    <content type="html"><![CDATA[<iframe class="youtube" width="640" height="360" src="//www.youtube.com/embed/DSHgjOvAFiA?rel=0" frameborder="0" allowfullscreen></iframe>


<!--more-->


<p>為了完成直覺與精準的Kinect操作方式，想要做到手部的細節辨識</p>

<p>由於Kinect與其他webcam的差別就在於它多了一個深度資訊的攝影機</p>

<p>所以其實關於姿勢辨識或是手指辨識的東西還是得靠自己寫!</p>

<p>完全沒有圖學背景的我就開始從網路上找一些手指辨識的資料</p>

<p>認識到OpenCV強大的影像處理類別庫，且大多數手指辨識似乎都是用這套類別庫完成的</p>

<p>於是我也到網路上找了OpenCV在AS3上的應用~找到有個神人寫了OpenCV的ANE</p>

<p>&hellip;.不過&hellip;..是mac only的&hellip;</p>

<p>好吧&hellip;.使用windows os還是得靠自己&hellip;</p>

<p>好好理解關於手指辨識的流程</p>

<p>也試著用as3來實做出來</p>

<p>最後也成功做出一個堪用的版本~</p>

<h3>實作手指偵測的步驟</h3>

<p><strong>1.利用骨架關節定位出右手(或左手)的區域範圍</strong></p>

<p><strong>2.擷取該區域範圍的深度影像來做影像處理，一方面可以減少大範圍的雜訊二方面可以提升辨識效能</strong></p>

<p><strong>3.利用右手座標得到該像素的色彩值並搭配bitmapData.threshold可以保留手部輪廓範圍</strong></p>

<p><strong>4.將得到的手部輪廓再做模糊化，用意是去除雜訊</strong></p>

<p><strong>5.將處理完的輪廓取出輪廓線</strong></p>

<p><strong>6.將輪廓線像素作順時針排列</strong></p>

<p><strong>7.使用K曲率(k-curvature)來作手指偵測</strong></p>

<p>這樣就能做出一個簡單的手指偵測與簡單的Open/Close</p>

<p>雖然還是有些小問題!不過也堪用了!</p>

<p>靜態圖片偵測效果如下圖:</p>

<p><img src="http://pcdn1.rimg.tw/photos/3340521_pezfyhu_l.jpg" alt="手指偵測" /></p>

<p>原始碼在這: <a href="http://dl.dropbox.com/u/68443214/AirKinectFingerDetectionDemo.rar">點我</a></p>

<p>小弟本人程度較差!可能寫了很多冗碼!</p>

<p>所以其實可以優化的地方還很多!請自己做修改!</p>

<p>由上圖可以看到抓指尖同時還會將凹陷處辨認為指尖!</p>

<p>這邊可以用手心與半徑範圍去辨識是指間還是凹陷處!</p>

<h1>How to use?</h1>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='as3'><span class='line'><span class="kd">var</span> <span class="n">kfd</span><span class="p">:</span><span class="kt">KinectFingerDetection</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">KinectFingerDetection</span><span class="o">();&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">kfd</span><span class="o">.</span><span class="na">onFingerDetection</span><span class="o">({&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="err">深度影像</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;},</span> <span class="o">{&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="err">要偵測的手掌關節座標</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;});&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;//</span><span class="err">手掌張開時會觸發的事件</span>
</span><span class='line'><span class="n">kfd</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">KinectFingerEvent</span><span class="o">.</span><span class="na">HAND_OPEN</span><span class="o">,</span> <span class="n">onkinectOpen</span><span class="o">);</span>
</span><span class='line'><span class="c1">//手掌握拳時會觸發的事件</span>
</span><span class='line'><span class="n">kfd</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">KinectFingerEvent</span><span class="o">.</span><span class="na">HAND_CLOSE</span><span class="o">,</span> <span class="n">onkinectClose</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用AIR透過ANE連接原生C++操控滑鼠-Part 2]]></title>
    <link href="http://sayaku.github.io/blog/2012/10/17/anec2/"/>
    <updated>2012-10-17T18:24:24+08:00</updated>
    <id>http://sayaku.github.io/blog/2012/10/17/anec2</id>
    <content type="html"><![CDATA[<p>我們最後產出一個dll動態連結類別檔</p>

<p>接下來我們要來撰寫AS端的程式碼</p>

<p>讓我們可以用鍵盤來控制滑鼠移動了！</p>

<!--more-->


<h3>Part2:AS端程式撰寫並生成ANE檔</h3>

<p>首先你可以在桌面上新建一個資料夾並且命名為<code>com<code></p>

<p>在裡面再創建一個資料夾,名稱可以用你的名字</p>

<p>最後打開flashdevelop新增一個as檔或是你用記事本編寫存成as檔也都可以</p>

<p>as檔的名稱可以自己取，這邊我取名<code>NativeApp.as</code></p>

<p>而這個as檔的路徑就像</p>

<p><code>com\ {yourName} \ {自己取的as}</code></p>

<p>以我的範例來說:</p>

<p><code>com\sayaku\NativeApp.as</code></p>

<p>內容如下</p>

<p><figure class='code'><figcaption><span>NativeApp.as </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='as3'><span class='line'><span class="k">package</span> <span class="nn">com.sayaku</span><span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">import</span> <span class="nn">flash.external.ExtensionContext</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">//如果想要讓此類別可以發送及偵聽事件可以繼承EventDispatcher</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="n">NativeApp</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">_ec</span><span class="p">:</span><span class="kt">ExtensionContext</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">function </span><span class="nf">NativeApp</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="n">_ec</span> <span class="o">=</span> <span class="n">ExtensionContext</span><span class="o">.</span><span class="na">createExtensionContext</span><span class="o">(</span><span class="s2">&quot;com.sayaku.NativeApp&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">function </span><span class="nf">setMousePos</span><span class="o">(</span><span class="n">_x</span><span class="o">:</span><span class="kt">int</span><span class="o">,</span> <span class="n">_y</span><span class="o">:</span><span class="kt">int</span><span class="o">):</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="c1">//調用原生C++的setMousePosition方法</span>
</span><span class='line'>   <span class="n">_ec</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s1">&#39;setMousePosition&#39;</span><span class="o">,</span> <span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">function </span><span class="nf">mouseClick</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="c1">//調用原生C++的mouseClick方法＿</span>
</span><span class='line'>   <span class="n">_ec</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s1">&#39;mouseClick&#39;</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">function </span><span class="nf">dispose</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="n">_ec</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>下面這段createExtensionContext方法會返回一個ExtensionContext的實體
<code>ExtensionContext.createExtensionContext(&lsquo;com.sayaku.NativeApp&rsquo;, &lsquo;&rsquo;);</code>
createExtensionContext的第一個參數是"識別用的ID"在這裡應該要是<code>com.你的名字.你的AS名稱</code></p>

<p>第二個參數目前還不知道要怎麼用~可以先填字串</p>

<p>接著我們要將我們的as檔封裝成swc</p>

<p>封裝成swc我們要使用命令提是字元程式</p>

<p>首先打開附屬應用程式下的命令提示字元</p>

<p>輸入
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd &ldquo;你自己flexSDK\bin的完整路徑&rdquo;</span></code></pre></td></tr></table></div></figure></p>

<p>以我的為範例</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd C:\Program Files\FlashDevelop\Tools\flexSDK4.6\bin</span></code></pre></td></tr></table></div></figure></p>

<p>會導航到我們自己flexSDK裡bin的目錄中</p>

<p>接下來我們下輸出swc的指令:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>acompc -source-path &ldquo;你com資料夾所在目錄的完整路徑&rdquo;-include-classes &ldquo;NativeApp.as的路徑&rdquo;-swf-version=&ldquo;你flashplayer的版本號&rdquo;-output &ldquo;輸出swc的路徑&rdquo;</span></code></pre></td></tr></table></div></figure></p>

<p>以我的範例:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>acompc -source-path C:\Users\sayaKU\Desktop -include-classes com.sayaku.NativeApp -swf-version=14 -output C:\Users\sayaKU\Desktop\com.sayaku.NativeApp.swc</span></code></pre></td></tr></table></div></figure></p>

<p>按下enter就能在桌面上看到輸出的swc</p>

<p><img src="http://pcdn1.rimg.tw/photos/3034597_inootzk_l.jpg" alt="001" /></p>

<p>生成swc以後,我們就可以跟之前編譯出來的dll檔包裝成ane檔了</p>

<p>包裝ane檔需要下面幾項東西</p>

<p><strong>1.dll檔</strong></br>
<strong>2.swc檔</strong></br>
<strong>3.swc裡的swf檔</strong></br>
<strong>4.xml描述檔</strong></br></p>

<p>我們先來製作描述檔，名稱可以自己取,這邊我是取<code>aneexpo.xml</code></p>

<p>內容如下:</p>

<p><figure class='code'><figcaption><span>aneexpo.xml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;extension</span> <span class="na">xmlns=</span><span class="s">&quot;http://ns.adobe.com/air/extension/3.1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;id&gt;</span>com.sayaku.NativeApp<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>    <span class="nt">&lt;versionNumber&gt;</span>1<span class="nt">&lt;/versionNumber&gt;</span>
</span><span class='line'>    <span class="nt">&lt;platforms&gt;</span>
</span><span class='line'>        <span class="nt">&lt;platform</span> <span class="na">name=</span><span class="s">&quot;Windows-x86&quot;</span><span class="nt">&gt;&lt;br/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;applicationDeployment&gt;&lt;br/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;nativeLibrary&gt;</span>NativeApp.dll<span class="nt">&lt;/nativeLibrary&gt;&lt;br/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;initializer&gt;</span>ExtInitializer<span class="nt">&lt;/initializer&gt;&lt;br/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;finalizer&gt;</span>ExtFinalizer<span class="nt">&lt;/finalizer&gt;&lt;br/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/applicationDeployment&gt;&lt;br/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/platform&gt;&lt;br/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/platforms&gt;</span>
</span><span class='line'><span class="nt">&lt;/extension&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>接下來我們建立一個資料夾命名可以自己取~我這邊是取aneexpo,用來裝入我們要發布ane檔的檔案</p>

<p>目前我們只有<code>NativeApp.dll</code><code>com.sayaku.NativeApp.swc</code><code>aneexpo.xml</code></p>

<p>還缺少一個swc裡的swf</p>

<p>所以我們直接將swc的副檔名直接改成zip</p>

<p>然後選擇解壓縮檔案去裡面尋找library.swf</p>

<p>然後把他拉出來</p>

<p>接下就可以把解壓縮出來的檔案砍掉</p>

<p>將壓縮檔副檔名zip改回成swc</p>

<p><img src="http://pcdn1.rimg.tw/photos/3034635_vbr2on7_l.jpg" alt="14" /></p>

<p>接下來終於進入到最後階段&hellip;&hellip;..發布ane檔</p>

<p>將aneexpo資料夾複製到你flexsdk\bin的目錄下</p>

<p>然後打開命令提示字元</p>

<p>先指向到flexsdk\bin的目錄下</p>

<p>然後輸入以下指令</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adt -package -target ane NativeApp.ane &ldquo;xml描述檔路徑&rdquo; -swc &ldquo;swc檔路徑&rdquo;-platform Windows-x86 -C &ldquo;原生dll檔與swf檔&rdquo;</span></code></pre></td></tr></table></div></figure></p>

<p>以我的範例
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adt -package -target ane NativeAdd.ane expo/expo.xml -swc expo/com.sayaku.NativeAdd.swc -platform Windows-x86 -C expo NativeAdd.dll library.swf</span></code></pre></td></tr></table></div></figure></p>

<p>按下enter就會在flexsdk\bin目錄下生成一個ane檔</p>

<p><img src="http://pcdn1.rimg.tw/photos/3034643_3tiexo6_l.jpg" alt="15" /></p>

<p>有了ane檔接下來要來做測試</p>

<p>打開FlashDevelop開啟一個新的AIR專案</p>

<p>ane的使用方式可以參考這篇→<a href="http://blog.roodo.com/sayaku/archives/19907808.html">點我</a></p>

<p>裡面有講到ane的設定</p>

<p>我們就利用鍵盤來控制鼠標位置與點擊事件來做測試</p>

<p>主檔案NativaMouse.as的內容</p>

<p><figure class='code'><figcaption><span>NativaMouse.as </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='as3'><span class='line'><span class="kd">package</span>
</span><span class='line'><span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="k">import</span> <span class="nn">com.sayaku.NativeApp</span><span class="o">;</span>
</span><span class='line'>   <span class="k">import</span> <span class="nn">flash.display.Sprite</span><span class="o">;</span>
</span><span class='line'>   <span class="k">import</span> <span class="nn">flash.events.KeyboardEvent</span><span class="o">;</span>
</span><span class='line'>   <span class="k">import</span> <span class="nn">flash.events.MouseEvent</span><span class="o">;</span>
</span><span class='line'>   <span class="k">import</span> <span class="nn">flash.ui.Keyboard</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="kd">public</span> <span class="kd">class</span> <span class="n">NativeMouse</span> <span class="kd">extends</span> <span class="n">Sprite</span>
</span><span class='line'>   <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">ane</span><span class="p">:</span><span class="kt">NativeApp</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">var</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">x</span><span class="o">:</span><span class="n">int</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">var</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">y</span><span class="o">:</span><span class="n">int</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">function </span><span class="nf">NativeMouse</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">ane</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NativeApp</span><span class="o">();&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'>        <span class="c1">//偵聽鍵盤事件</span>
</span><span class='line'>        <span class="n">stage</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">KeyboardEvent</span><span class="o">.</span><span class="na">KEY_DOWN</span><span class="o">,</span> <span class="n">keydown</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="c1">//畫一個黑色矩形做為測試滑鼠點擊的區域</span>
</span><span class='line'>    <span class="kd">var</span> <span class="n">sp</span><span class="p">:</span><span class="kt">Sprite</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Sprite</span><span class="o">();</span>
</span><span class='line'>    <span class="n">addChild</span><span class="o">(</span><span class="n">sp</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="na">graphics</span><span class="o">.</span><span class="na">beginFill</span><span class="o">(</span><span class="mh">0x000000</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="na">graphics</span><span class="o">.</span><span class="na">drawRect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="na">graphics</span><span class="o">.</span><span class="na">endFill</span><span class="o">();</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="na">buttonMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">MouseEvent</span><span class="o">.</span><span class="na">CLICK</span><span class="o">,</span> <span class="kd">function</span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="n">MouseEvent</span><span class="o">):</span><span class="kc">void</span> <span class="o">{</span> <span class="nf">trace</span><span class="o">(</span><span class="s2">&quot;我點到了!!&quot;</span><span class="o">)</span> <span class="o">}</span> <span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">keydown</span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="kt">KeyboardEvent</span><span class="o">):</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="c1">//根據鍵盤按的方向去移動滑鼠的位置</span>
</span><span class='line'>    <span class="k">switch</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">keyCode</span><span class="o">)</span>
</span><span class='line'>            <span class="o">{</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">Keyboard</span><span class="o">.</span><span class="na">UP</span><span class="o">:</span>      <span class="n">_y</span><span class="o">-=</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">ane</span><span class="o">.</span><span class="na">setMousePos</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
</span><span class='line'>                <span class="k">break</span><span class="o">;</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">Keyboard</span><span class="o">.</span><span class="na">DOWN</span><span class="o">:</span>    <span class="n">_y</span><span class="o">+=</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">ane</span><span class="o">.</span><span class="na">setMousePos</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
</span><span class='line'>                <span class="k">break</span><span class="o">;</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">Keyboard</span><span class="o">.</span><span class="na">LEFT</span><span class="o">:</span>    <span class="n">_x</span><span class="o">-=</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">ane</span><span class="o">.</span><span class="na">setMousePos</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
</span><span class='line'>                <span class="k">break</span><span class="o">;</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">Keyboard</span><span class="o">.</span><span class="na">RIGHT</span><span class="o">:</span>   <span class="n">_x</span><span class="o">+=</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">ane</span><span class="o">.</span><span class="na">setMousePos</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
</span><span class='line'>                <span class="k">break</span><span class="o">;</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">Keyboard</span><span class="o">.</span><span class="na">SPACE</span><span class="o">:</span>   <span class="n">ane</span><span class="o">.</span><span class="na">mouseClick</span><span class="o">()</span> <span class="o">;</span>
</span><span class='line'>                    <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>發布後我們就可以用鍵盤去控制鼠標的位置</p>

<p>並且移到黑色方塊上按下空白鍵也會發生點擊事件喔!</p>

<p><img src="http://pcdn1.rimg.tw/photos/3034695_kvn5a94_l.jpg" alt="16" /></p>

<p>原始檔底加→<a href="http://dl.dropbox.com/u/68443214/ANEMouse.rar">點我</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用AIR透過ANE連接原生C++操控滑鼠-Part 1]]></title>
    <link href="http://sayaku.github.io/blog/2012/10/17/anec1/"/>
    <updated>2012-10-17T15:30:50+08:00</updated>
    <id>http://sayaku.github.io/blog/2012/10/17/anec1</id>
    <content type="html"><![CDATA[<p><img src="http://pcdn1.rimg.tw/photos/3030609_smej5qs_l.jpg" alt="12" /></p>

<!--more-->


<p>大家好我是阿邪。</p>

<p>以前在製作FLASH時，我們可以透過滑鼠的控制來達成許多互動效果。</p>

<p>可是今天如果反過來說:那我們能不能不用滑鼠去控制系統滑鼠座標與點擊動作?</p>

<p>FLASH能辦到的只有透過dispatchEvent()去發送一個假的滑鼠點擊事件，但充其量它還是個模擬出來的假事件!!</p>

<p>改變系統滑鼠座標，單靠目前的FLASH是辦不到的，還是得靠系統原生語言來控制!</p>

<p>好在現在我們可以利用AIR透過ANE(AIR Native Extension)原生擴充功能來與原生語言動態函式庫的聯繫。</p>

<p>目前關於ANE的文章大部分都是以行動裝置ios,android的原生拓展的文章較多</p>

<p>桌面應用程式方面的原生拓展文章則較少著墨。</p>

<p>剛好現在做的專案遇到這樣的問題，順便來筆記一下如何讓AIR透過ANE去跟C++溝通。</p>

<p>本教學原文是參考此篇教學:<a href="http://rhuno.com/flashblog/2012/04/30/tutorial-flash-and-c-native-extension/">點我</a></p>

<h4>以下是我的開發環境:</h4>

<p><a href="http://www.flashdevelop.org/">FlashDevelop 4.0.4 RTM</a></br>
<a href="http://www.adobe.com/devnet/flex/flex-sdk-download.html">FlexSDK 4.6(目前最新版本為4.6)</a></br>
<a href="http://www.adobe.com/devnet/air/air-sdk-download.html">AIRSDK 3.3 (目前最新版本為3.4，至少要3.0以上)</a></br>
<a href="http://www.microsoft.com/visualstudio/eng/products/visual-studio-express-products">M$ Visual Studio Express 2012</a></br></p>

<h3>Part1 : C++端的程式撰寫</h3>

<p>在此聲明!我是個Flasher!!我完完全全的不會寫C++</p>

<p>所以內文有疑慮或是解釋錯的地方煩請高手多多包涵!</p>

<p>首先打開我們的Visual Studio Express 2012</p>

<p>新增專案:</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030295_ca9jfsq_l.jpg" alt="01" /></p>

<p>選擇Win32專案</p>

<p>並填好專案名稱跟儲存位置</p>

<p>我專案名稱是命名NativeApp</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030297_5kwzpib_l.jpg" alt="02" /></p>

<p>應用程式類型選擇為DLL(Dynamic Link Library)動態連結類別庫</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030439_dvfphnv_l.jpg" alt="03" /></p>

<p>先到dllmain.cpp,這是dll程式的進入點</p>

<p>將dllmain.cpp預設內容改成</p>

<p><figure class='code'><figcaption><span>dllmain.cpp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// dllmain.cpp : 定義 DLL 應用程式的進入點。&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">windows</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="n">DllMain</span><span class="p">(</span> <span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>之後將原始程式檔裡的<code>stdafx.cpp</code>跟標頭檔裡兩個<code>stdafx.h</code>跟<code>targetver.h</code>砍掉</p>

<p>然後到你下載好的flex sdk裡include資料夾</p>

<p>將裡面的<code>FlashRuntimeExtensions.h</code>複製起來</p>

<p>到你NativeApp的專案裡的NativeApp資料夾貼上</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030359_j9885ui_l.jpg" alt="04" /></p>

<p>OK之後再回到Flex SDK>lib找到win資料夾</p>

<p>裡面有一個<code>FlashRuntimeExtensions.lib</code>把它複製起來</p>

<p>一樣把它丟到你NativeApp的專案裡的NativeApp資料夾</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030377_mtcyb9y_l.jpg" alt="05" /></p>

<p>這個階段OK之後回到Visual Studio Express 2012</p>

<p>在標頭檔的資料夾上按右鍵加入>現有項目>FlashRuntimeExtensions.h</p>

<p>結束後再加入一個新增項目>選擇標頭檔(.h),然後命名<code>NativeApp.h</code></p>

<p><img src="http://pcdn1.rimg.tw/photos/3030381_z6ypkai_l.jpg" alt="06" /></p>

<p>下一個步驟就是將<code>FlashRuntimeExtensions.lib</code>給加進來</p>

<p>在上面的NativeApp按右建>加入>現有項目>FlashRuntimeExtensions.lib</p>

<p>全部改完之後會像這樣</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030389_4pn6q5h_l.jpg" alt="07" /></p>

<p>接下來因為我們之前去掉<code>stdafx.h</code>，我們需要告訴編譯器不要找到他!不然會一直出錯!!</p>

<p>我們到NativeApp上按右鍵選擇屬性 > C/C++ > 先行編譯標頭檔選擇未使用先行編譯標頭檔!</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030393_uddbl1m_l.jpg" alt="08" /></p>

<p>設定差不多了!可以開始coding了!</p>

<p>首先打開<code>NativeApp.h</code></p>

<p>我們輸入以下程式碼</p>

<p><figure class='code'><figcaption><span>NativeApp.h </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">FlashRuntimeExtensions</span><span class="p">.</span><span class="n">h</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c1">//用 extern &amp;ldquo;C&quot;將C++指令轉換成C語言</span>
</span><span class='line'><span class="c1">//原因是防止C++名稱重整器造成函數名稱的錯位</span>
</span><span class='line'><span class="k">extern</span> <span class="s">&quot;C&amp;rdquo;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">ExtInitializer</span><span class="p">(</span><span class="kt">void</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">extDataToSet</span><span class="p">,</span> <span class="n">FREContextInitializer</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">ctxInitializerToSet</span><span class="p">,</span> <span class="n">FREContextFinalizer</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">ctxFinalizerToSet</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">ExtFinalizer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">extData</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">FREObject</span> <span class="n">setMousePosition</span><span class="p">(</span><span class="n">FREContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">funcData</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">FREObject</span> <span class="n">argv</span><span class="p">[]);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">FREObject</span> <span class="n">mouseClick</span><span class="p">(</span><span class="n">FREContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">funcData</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">FREObject</span> <span class="n">argv</span><span class="p">[]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>這邊宣告四種方法</p>

<p><strong>初始化(ExtInitializer)與終結(ExtFinalizer)這兩個方法是必須的</strong></p>

<p><strong>setMousePosition,mouseClick這兩個方法是用來給AS3調用的</strong></p>

<p><strong>setMousePosition是改變系統滑鼠的座標</strong></p>

<p><strong>mouseClick是觸發系統的滑鼠Click</strong></p>

<p>接下來編寫<code>NativeApp.cpp</code>
輸入以下程式</p>

<p><figure class='code'><figcaption><span>NativeApp.cpp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">NativeApp</span><span class="p">.</span><span class="n">h</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">windows</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">extern</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">C</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="n">FREObject</span> <span class="n">setMousePosition</span><span class="p">(</span><span class="n">FREContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">funcData</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">FREObject</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>    <span class="c1">//AS3傳來的參數會存在argv[]裡</span>
</span><span class='line'>    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1">//將AS3數據轉成C++</span>
</span><span class='line'><span class="n">FREGetObjectAsInt32</span> <span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'><span class="n">FREGetObjectAsInt32</span> <span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">y</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//設定系統的座標,為Windows.h裡的方法</span>
</span><span class='line'><span class="n">SetCursorPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//如果不在意回傳數值就回傳第一個參數</span>
</span><span class='line'><span class="c1">//如果需要回傳經計算過的數值請記得利用FRE Object轉成AS3看得懂的數據</span>
</span><span class='line'><span class="k">return</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="n">FREObject</span> <span class="n">mouseClick</span><span class="p">(</span><span class="n">FREContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">funcData</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">FREObject</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>    <span class="c1">//觸發滑鼠事件,click事件其實就是mousedown跟mouseup的組合</span>
</span><span class='line'>    <span class="n">mouse_event</span><span class="p">(</span><span class="n">MOUSEEVENTF_LEFTDOWN</span> <span class="o">|</span> <span class="n">MOUSEEVENTF_LEFTUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>   <span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="kt">void</span> <span class="n">ContextInitializer</span><span class="p">(</span><span class="kt">void</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">extData</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">ctxType</span><span class="p">,</span> <span class="n">FREContext</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">numFunctions</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRENamedFunction</span><span class="o">**</span> <span class="n">functions</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>    <span class="c1">//在初始化時宣告可以被AS3調用的方法</span>
</span><span class='line'>    <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">numFunctions</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="n">FRENamedFunction</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">FRENamedFunction</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FRENamedFunction</span><span class="p">)</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">numFunctions</span><span class="p">));</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;setMousePosition&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">functionData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">setMousePosition</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;mouseClick&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">functionData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">mouseClick</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">*</span><span class="n">functions</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">ContextFinalizer</span><span class="p">(</span><span class="n">FREContext</span> <span class="n">ctx</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">ExtInitializer</span><span class="p">(</span><span class="kt">void</span><span class="o">**</span> <span class="n">extData</span><span class="p">,</span> <span class="n">FREContextInitializer</span><span class="o">*</span> <span class="n">ctxInitializer</span><span class="p">,</span> <span class="n">FREContextFinalizer</span><span class="o">*</span> <span class="n">ctxFinalizer</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">*</span><span class="n">ctxInitializer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ContextInitializer</span><span class="p">;</span>
</span><span class='line'><span class="o">*</span><span class="n">ctxFinalizer</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ContextFinalizer</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">ExtFinalizer</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">extData</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>結束後!程式就完成了!可以編譯出dll檔</p>

<p>選擇上方的"建置">建置方案</p>

<p>當然你可以選擇你要編譯debug還是release版本</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030423_c0xo82a_l.jpg" alt="9" /></p>

<p>編譯成功下面會輸出</p>

<p><img src="http://pcdn1.rimg.tw/photos/3030425_bondyg4_l.jpg" alt="10" /></p>

<p>關於C++與AS3之間的數據轉換的類別可以參考→<a href="http://help.adobe.com/en_US/air/extensions/WS460ee381960520ad-866f9c112aa6e1ad46-7ff8.html">點我</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Away3D歐拉旋轉所造成的GimbalLock現象]]></title>
    <link href="http://sayaku.github.io/blog/2012/06/30/gimballock/"/>
    <updated>2012-06-30T00:08:17+08:00</updated>
    <id>http://sayaku.github.io/blog/2012/06/30/gimballock</id>
    <content type="html"><![CDATA[<iframe src="https://dl.dropboxusercontent.com/u/68443214/gimbalLock/GimbalLock.html" width="640" height="500" frameborder="o"></iframe>




<!--more-->


<p>所謂的gimballock我們稱為萬向鎖、萬向節鎖或稱平橫軸死鎖</p>

<p>這是在歐拉旋轉系統可能會碰到的一個惱人問題!!</p>

<p>歐拉旋轉系統是一般3D製圖軟體最基礎的旋轉系統</p>

<p>雖然3D軟體裡執行物件旋轉時看不出歐拉系統的旋轉軸</p>

<p>然而電腦背後還是使用歐拉旋轉系統來做旋轉</p>

<p>所以一般3D繪圖軟體所標的旋轉軸線也只是參考用。</p>

<p>在歐拉旋轉系統中</p>

<p>它把空間中的旋轉獨立成roll,pitch,yaw這三個軸向的旋轉。</p>

<p><img src="http://pcdn1.rimg.tw/photos/2593243_608qk49_l.png" alt="rpy" /></p>

<p>這三個軸向在不同座標系分別代表不同的軸向</p>

<p>如果以笛卡兒座標系來說</p>

<p>roll代表空間中物體X軸向的旋轉</p>

<p>pitch代表空間中物體Y軸向的旋轉</p>

<p>yaw代表空間中物體Z軸向的旋轉</p>

<p>而在Flash away3D裡的座標系</p>

<p>roll代表空間中物體Z軸向的旋轉</p>

<p>pitch代表空間中物體X軸向的旋轉</p>

<p>yaw代表空間中物體Y軸向的旋轉</p>

<p>而歐拉旋轉是有順序與階層性的</p>

<p>例如先轉X軸再轉Y軸與先轉Y軸再轉X軸的結果是不同的</p>

<p>而階層性，可以用旋轉順序來定義</p>

<p>如果旋轉順序是X→Y→Z</p>

<p>則X旋轉時會同時牽動子階層Y、Z軸</p>

<p>Y軸旋轉時會牽動子階層Z軸但不會牽動到父階層X軸</p>

<p>而Z旋轉時只有本身的旋轉並不會影響到它的父階層X、Y軸</p>

<p>所以這時三軸各自旋轉時就有可能會造成GimbalLock現象</p>

<p>例如本篇文章最上面的範例裡</p>

<p>旋轉到第二步驟會發現Z軸跟X軸重疊於同一個平面</p>

<p>所以你不論你去轉Z軸跟X軸就相當是在同一個軸向上旋轉</p>

<p>也代表失去一個軸向的自由度(三軸旋轉變成兩軸旋轉!!)</p>

<p>在旋轉時可能造成旋轉效果不如預期的問題</p>

<p>即使轉換成矩陣旋轉一樣也避免不了GimbalLock的問題</p>

<p>所以這時處理空間中的旋轉，我們可以使用四元數旋轉來避免GimbalLock</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Away3d Quaternion 使用四元數來處理空間中的旋轉]]></title>
    <link href="http://sayaku.github.io/blog/2012/05/27/quaternion/"/>
    <updated>2012-05-27T20:55:21+08:00</updated>
    <id>http://sayaku.github.io/blog/2012/05/27/quaternion</id>
    <content type="html"><![CDATA[<iframe src="https://dl.dropboxusercontent.com/u/68443214/QuaternionRotation/bin/index.html" width="640" height="480" frameborder="o"></iframe>




<!--more-->


<p>大家好我是阿邪!</p>

<p>最近因為要計算一些空間中的位移與旋轉</p>

<p>不得不要理解一些數學的運算</p>

<p>要了解3D引擎如何在空間中運算</p>

<p>了解向量與矩陣的基礎知識是必要的</p>

<p>因為大學不是相關科系的</p>

<p>距離上一次算這些東西大概是高中指考前</p>

<p>所以現在關於這些數學觀念全還給高中老師了</p>

<p>標題提到的四元數必須要了解這些概念才會比較好懂!</p>

<p>所以最近幾天都在算數學</p>

<h2>向量</h2>

<p>其實向量概念很簡單</p>

<p>它可以表示一個座標點、方向跟長度</p>

<p>假設一原點<code>O(0,0)</code> 與<code>P(a,b)</code></p>

<p>則OP向量我們可以用P點的座標來表示</p>

<p>空間中的兩點:</p>

<p>空間中有兩點 <code>A(a,b,c)</code> 與 <code>B(d,e,f)</code></p>

<p>則AB向量是 <code>AB( d-a , e-b , f-c )</code></p>

<p>這是個簡單的向量</p>

<h3>向量長度:</h3>

<p>向量A(a,b,c)</p>

<p>長度=<code>Math.sqr(a<em>a+b</em>b+c*c)</code></p>

<h2>向量的運算</h2>

<h3>向量的加減(位移):</h3>

<p>A向量(a,b,c) , B向量(d,e,f)
<figure class='code'><figcaption><span>向量加法</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>加法: A向量+B向量 = (a+d , b+e , c+f);</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>向量減法</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>減法: A向量 - B向量= (a-d , b-e , c-f);</span></code></pre></td></tr></table></div></figure></p>

<h2>向量的運算滿足交換律與結合律</h2>

<p><figure class='code'><figcaption><span>向量交換律 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>交換律:A+B=B+A</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>向量結合律 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>結合律:A+(B+C)=(A+B)+C</span></code></pre></td></tr></table></div></figure></p>

<h3>向量的乘法(縮放):</h3>

<p><figure class='code'><figcaption><span>向量的乘法 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>常數x乘與向量A(a,b,c)=(x&lt;em>a , x&lt;/em>b , x*c);</span></code></pre></td></tr></table></div></figure></p>

<h3>向量的內積(點積):</h3>

<p>符號是<code>‧</code>
兩向量的內積為一個純數
也代表A向量投影在B向量上的分量</p>

<p>向量A(a,b,c)與向量B(d,e,f)</p>

<p>則向量<code>A ‧ B</code>
<figure class='code'><figcaption><span>向量內積 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>A ‧ B=(a&lt;em>d + b&lt;/em>e + c&lt;em>f)=A向量的長度&lt;/em>B向量的長度*cosq;</span></code></pre></td></tr></table></div></figure></p>

<p>我們可以使用內積來求兩向量的夾角!</p>

<h3>向量的外積(叉積):</h3>

<p>符號是<code>X</code></p>

<p>向量的外積還是一個向量</p>

<p>向量A(a,b,c)與向量B(d,e,f)</p>

<p>則<code>A X B</code>
<figure class='code'><figcaption><span>向量外積 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>A X B=(a&lt;em>f-c&lt;/em>e ,  c&lt;em>d-a&lt;/em>f , a&lt;em>e-b&lt;/em>d)</span></code></pre></td></tr></table></div></figure></p>

<p>得出來的新向量會垂直於A向量與B向量</p>

<p>所以也是A向量與B向量構成的平面上的法向量</p>

<p>另外向量的外積是不滿足交換律的</p>

<p><code>A X B</code>與<code>B X A</code>是不同的!但是兩個得出來的方向剛好相反</p>

<h2>矩陣</h2>

<p>我們可以將向量轉成矩陣</p>

<p>去運算在空間中的平移與旋轉</p>

<p>空間中的平移會用到矩陣的加法與減法</p>

<p>旋轉會用到矩陣的相乘</p>

<p>所以我們3D引擎裡的rotation X,Y,Z其實背後都是在做旋轉矩陣的運算!</p>

<p>一些算式在這邊都有:<a href="http://www.nicoptere.net/noobie_ninja/lib/doc/3d_cheatsheet.pdf">點我</a></p>

<p>關於矩陣的運算與原理</p>

<p>可以看這些:<a href="http://book.51cto.com/art/200808/84772.htm">點我</a></p>

<p>呼!打好久!接下來終於要進入本篇的主題:四元數</p>

<p>四元數不是個數!它是一個數學的模型!</p>

<p>是由愛爾蘭學家威廉·盧雲·哈密頓發現的</p>

<p>有興趣可以去看維基百科:<a href="http://zh.wikipedia.org/wiki/%E5%9B%9B%E5%85%83%E6%95%B8">點我</a></p>

<p>看了以後!發現還是看不懂!只知道他有4個分量<code>w</code>,<code>x</code>,<code>y</code>,<code>z</code></p>

<p>x,y,z是虛數,w是實數</p>

<p>那跟旋轉有甚麼關係呢?</p>

<p>還好在空間中的四元數不需要從數學的角度去理解(因為我看了好久還是看不懂)</p>

<p>四元數在空間中可以儲存四種分量!畢竟叫四元數就是有四個元素組成</p>

<p>簡單來說可以把四元數表示成:</p>

<p>x,y,z是一個向量!而w是以這個向量為旋轉軸所繞的角度</p>

<p>所以我們可以利用四元數來計算空間中的旋轉</p>

<p>那為什麼要用四元數呢?</p>

<p>以前一般來作空間中的旋轉式使用旋轉矩陣來運算</p>

<p>但它很不好清楚的表示出X,Y,Z的旋轉角度</p>

<p>於是有了歐拉角(Euler)來表示旋轉角度!</p>

<p>但使用歐拉角來表示空間中的旋轉!會有一個很大的問題!</p>

<p>就是萬向死鎖(Gimbal Lock)</p>

<p>簡單來說就是經過3軸旋轉以後~可能會演變成旋轉軸重疊!導至只能轉一個方向</p>

<p>這邊有一個影片可以說明萬向鎖</p>

<iframe class="youtube" width="480" height="480" src="//www.youtube.com/embed/zc8b2Jo7mno?rel=0" frameborder="0" allowfullscreen></iframe>


<p>所以在四元數的實作中可以避免掉萬向鎖的問題</p>

<p>基本上還蠻多地方會用到四元數</p>

<p>比如3D模型的骨架</p>

<p>它們骨塊關節的旋轉都是運用四元數</p>

<p>我們這邊使用四元數來實作一個地球任意方向的旋轉</p>

<p>這邊使用的是away3d 4 beta的3D引擎</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
</pre></td><td class='code'><pre><code class='as3'><span class='line'><span class="kd">package</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.cameras.Camera3D</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.containers.Scene3D</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.containers.View3D</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.core.math.Quaternion</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.entities.Mesh</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.lights.PointLight</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.materials.lightpickers.StaticLightPicker</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.materials.TextureMaterial</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.primitives.SphereGeometry</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.textures.BitmapTexture</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">away3d.tools.utils.Ray</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">flash.display.Sprite</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">flash.events.Event</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">flash.geom.Matrix3D</span><span class="o">;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">flash.geom.Vector3D</span><span class="o">;</span>
</span><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;*</span>
</span><span class='line'> <span class="o">*</span> <span class="o">&amp;</span><span class="n">hellip</span><span class="o">;</span>
</span><span class='line'> <span class="o">*</span> <span class="err">@</span><span class="n">author</span> <span class="n">sayaku</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="o">[</span><span class="n">SWF</span><span class="o">(</span><span class="n">frameRate</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mi">60</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span><span class="n">width</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mi">800</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;,</span><span class="n">height</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mi">600</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)]</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="n">QuaternionEarth</span> <span class="kd">extends</span> <span class="n">Sprite</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="o">[</span><span class="n">Embed</span><span class="o">(</span><span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;../</span><span class="n">bin</span><span class="sr">/assets/</span><span class="n">earth</span><span class="o">.</span><span class="na">jpg</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)]</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">EarthSkin</span><span class="p">:</span><span class="kt">Class</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">view</span><span class="p">:</span><span class="kt">View3D</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">camera</span><span class="p">:</span><span class="kt">Camera3D</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">scene</span><span class="p">:</span><span class="kt">Scene3D</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">mesh</span><span class="p">:</span><span class="kt">Mesh</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">light</span><span class="p">:</span><span class="kt">PointLight</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">lightPicker</span><span class="p">:</span><span class="kt">StaticLightPicker</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">ray</span><span class="p">:</span><span class="kt">Ray</span><span class="o">;//</span><span class="err">直線運算</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">SPEED</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="o">.</span><span class="mi">97</span><span class="o">;//</span><span class="err">減速度</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">var</span> <span class="n">radius</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="mi">350</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">function </span><span class="nf">QuaternionEarth</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">stage</span><span class="o">)</span> <span class="n">init</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="k">else</span> <span class="n">addEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">ADDED_TO_STAGE</span><span class="o">,</span> <span class="n">init</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">init</span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">removeEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">ADDED_TO_STAGE</span><span class="o">,</span> <span class="n">init</span><span class="o">);</span>
</span><span class='line'><span class="n">initEngine</span><span class="o">();</span>
</span><span class='line'><span class="n">initLight</span><span class="o">();</span>
</span><span class='line'>    <span class="n">initObj3D</span><span class="o">();</span>
</span><span class='line'><span class="n">initListener</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">initEngine</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">View3D</span><span class="o">();</span>
</span><span class='line'><span class="n">scene</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">scene</span><span class="o">;</span>
</span><span class='line'><span class="n">camera</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">camera</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">addChild</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">initLight</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">light</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">PointLight</span><span class="o">();</span>
</span><span class='line'><span class="n">light</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
</span><span class='line'><span class="n">light</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3000</span><span class="o">;</span>
</span><span class='line'><span class="n">light</span><span class="o">.</span><span class="na">ambient</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'><span class="n">scene</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">light</span><span class="o">);</span>
</span><span class='line'><span class="n">lightPicker</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">StaticLightPicker</span><span class="o">([</span><span class="n">light</span><span class="o">]);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">initObj3D</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">var</span> <span class="n">sphere</span><span class="p">:</span><span class="kt">SphereGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">SphereGeometry</span><span class="o">(</span><span class="n">radius</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">50</span><span class="o">);</span>
</span><span class='line'><span class="kd">var</span> <span class="n">mt</span><span class="p">:</span><span class="kt">TextureMaterial</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">TextureMaterial</span><span class="o">(</span><span class="k">new</span> <span class="kt">BitmapTexture</span><span class="o">(</span><span class="k">new</span> <span class="kt">EarthSkin</span><span class="o">().</span><span class="n">bitmapData</span><span class="o">));</span>
</span><span class='line'><span class="n">mt</span><span class="o">.</span><span class="na">specular</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mt</span><span class="o">.</span><span class="na">gloss</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
</span><span class='line'><span class="n">mt</span><span class="o">.</span><span class="na">ambientColor</span> <span class="o">=</span> <span class="mh">0x333333</span><span class="o">;</span>
</span><span class='line'><span class="n">mt</span><span class="o">.</span><span class="na">ambient</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
</span><span class='line'><span class="n">mt</span><span class="o">.</span><span class="na">lightPicker</span> <span class="o">=</span> <span class="n">lightPicker</span><span class="o">;</span>
</span><span class='line'><span class="n">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Mesh</span><span class="o">();</span>
</span><span class='line'><span class="n">mesh</span><span class="o">.</span><span class="na">geometry</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">;</span>
</span><span class='line'><span class="n">mesh</span><span class="o">.</span><span class="na">material</span> <span class="o">=</span> <span class="n">mt</span><span class="o">;</span>
</span><span class='line'><span class="n">scene</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">mesh</span><span class="o">);</span>
</span><span class='line'><span class="n">ray</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Ray</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">initListener</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">addEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">ENTER_FRAME</span><span class="o">,</span> <span class="n">onRender</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">onRender</span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">view</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
</span><span class='line'><span class="n">updataRotation</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">function </span><span class="nf">updataRotation</span><span class="o">():</span><span class="kt">void</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span> <span class="kd">var</span> <span class="n">mouse3DPos</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">unproject</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">mouseX</span><span class="o">,</span> <span class="n">view</span><span class="o">.</span><span class="na">mouseY</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">//利用反投影得到2D平面的滑鼠位置轉換成3D空間中的點</span>
</span><span class='line'> <span class="kd">var</span> <span class="n">currentEarthMt</span><span class="p">:</span><span class="kt">Matrix3D</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="na">transform</span><span class="o">;</span>
</span><span class='line'><span class="c1">//取得現在地球在空間中的矩陣</span>
</span><span class='line'><span class="c1">//============================================ &lt;br/&gt;</span>
</span><span class='line'><span class="c1">//宣告一個XY平面的四個頂點</span>
</span><span class='line'>     <span class="kd">var</span> <span class="n">v1</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Vector3D</span><span class="o">(</span> <span class="o">-</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>     <span class="kd">var</span> <span class="n">v2</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Vector3D</span><span class="o">(</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>     <span class="kd">var</span> <span class="n">v3</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Vector3D</span><span class="o">(</span> <span class="mi">1000</span><span class="o">,</span> <span class="o">-</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>     <span class="kd">var</span> <span class="n">v4</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Vector3D</span><span class="o">(</span> <span class="o">-</span><span class="mi">1000</span><span class="o">,</span> <span class="o">-</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="c1">//============================================     &lt;br/&gt;</span>
</span><span class='line'>     <span class="kd">var</span> <span class="n">interSection</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector3D</span><span class="o">;</span>
</span><span class='line'><span class="c1">//相機到空間中滑鼠點的向量與XY平面的交點(也代表原點到此交點的向量)&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">(</span><span class="n">ray</span><span class="o">.</span><span class="na">getRayToTriangleIntersection</span><span class="o">(</span><span class="n">camera</span><span class="o">.</span><span class="na">position</span><span class="o">,</span> <span class="n">mouse3DPos</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">,</span> <span class="n">v3</span><span class="o">))</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">interSection</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="na">getRayToTriangleIntersection</span><span class="o">(</span><span class="n">camera</span><span class="o">.</span><span class="na">position</span><span class="o">,</span> <span class="n">mouse3DPos</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">,</span> <span class="n">v3</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="n">interSection</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="na">getRayToTriangleIntersection</span><span class="o">(</span><span class="n">camera</span><span class="o">.</span><span class="na">position</span><span class="o">,</span> <span class="n">mouse3DPos</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">v4</span><span class="o">,</span> <span class="n">v3</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">interSection</span> <span class="o">||=</span> <span class="k">new</span> <span class="n">Vector3D</span><span class="o">;</span>
</span><span class='line'>    <span class="c1">//如果是null就NEW一個出來</span>
</span><span class='line'>
</span><span class='line'><span class="n">interSection</span><span class="o">.</span><span class="na">scaleBy</span><span class="o">(</span><span class="n">SPEED</span><span class="o">);</span>
</span><span class='line'>     <span class="c1">//向量乘以一個倍數來表示旋轉速度    </span>
</span><span class='line'><span class="kd">var</span> <span class="n">distance</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="n">interSection</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span><span class='line'>    <span class="c1">//計算長度      </span>
</span><span class='line'><span class="kd">var</span> <span class="n">normalDir</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Vector3D</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">//XY平面的法向量</span>
</span><span class='line'><span class="kd">var</span> <span class="n">rotationAxis</span><span class="p">:</span><span class="kt">Vector3D</span> <span class="o">=</span> <span class="n">interSection</span><span class="o">.</span><span class="na">crossProduct</span><span class="o">(</span><span class="n">normalDir</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">//兩向量作外積可得到垂直於兩向量的向量(即我們需要的旋轉軸)</span>
</span><span class='line'><span class="n">rotationAxis</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//旋轉軸記得要正規化!不然轉起來會頓頓</span>
</span><span class='line'><span class="kd">var</span> <span class="n">q</span><span class="p">:</span><span class="kt">Quaternion</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Quaternion</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//四元數</span>
</span><span class='line'><span class="n">q</span><span class="o">.</span><span class="na">fromAxisAngle</span><span class="o">(</span><span class="n">rotationAxis</span><span class="o">,</span> <span class="o">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">radius</span><span class="o">));</span>
</span><span class='line'><span class="n">q</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//如果沒有再作其他四元數的運算,不正規化也沒關係</span>
</span><span class='line'>
</span><span class='line'><span class="n">currentEarthMt</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">toMatrix3D</span><span class="o">());</span>
</span><span class='line'>    <span class="c1">//矩陣運算(兩矩陣相乘)改變目前地球的旋轉角度</span>
</span><span class='line'><span class="n">mesh</span><span class="o">.</span><span class="na">transform</span><span class="o">=</span><span class="n">currentEarthMt</span> <span class="o">;</span>
</span><span class='line'>    <span class="c1">//再指定給現在的地球</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>   <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>看一下這個地球旋轉用到的概念</p>

<p><img src="http://pcdn1.rimg.tw/photos/2483131_4oc2t9o_l.jpg" alt="er" /></p>

<p>從這張圖可以講解這個DEMO的基本概念</p>

<p>基本上我們的目的就是要算出地球的旋轉軸</p>

<p>首先我們利用unproject將2D的滑鼠位置轉成在空間中的位置,轉換後z值是20,我也不知道為什麼!蠻特殊的轉換法</p>

<p>接下來有了滑鼠在空間中的點就能算攝影機到這個點的向量</p>

<p>然後要算出這個向量跟XY平面的交點則是利用Ray類別裡的<code>getRayToTriangleIntersection()</code>方法</p>

<p>這個方法只能算你給的三角形面與這個向量的交點(其實平面就是兩個三角型組成的)</p>

<p>getRayToTriangleIntersection()的參數分別是<code>(&ldquo;向量的起點&rdquo;,&ldquo;向量的終點&rdquo;,&ldquo;三角形的三個頂點&rdquo;)</code></p>

<p>如果沒有交點的話會回傳null</p>

<p>所以將我們定義的XY平面的頂點拆成兩個三角形去用if來判斷現在是在哪個平面有交點</p>

<p>算出交點後~就表示地球是要往你那個交點方向旋轉</p>

<p>那要算出旋轉軸就很簡單了</p>

<p>只要交點這個向量與Z軸向量作外積就可以做出垂直於這兩個向量的向量也就是我們要的旋轉軸</p>

<p>得到向量的旋轉軸要做正規化的動作</p>

<p>因為我們只需要這個向量的方向~不需要它的長度跟座標!所以將它正規化</p>

<p>正規化的意義就是使這個向量的長度為1,如果你不做正規化!在運算時可能會超出範圍!</p>

<p>所以務必要使用向量正規化!正規化後原本的座標與長度就被蓋掉了!這點要注意</p>

<p>然後再用四元數去處理旋轉就OK了</p>

<p>基本上四元數能算旋轉但是不能直接給出角度!所以還是要轉成矩陣去做矩陣運算</p>

<p>原始碼下載:<a href="https://www.box.com/s/ffcnoi5km4g05vqtnfme">點我</a></p>

<p>如果數學概念有錯的話請指正:)</p>
]]></content>
  </entry>
  
</feed>
